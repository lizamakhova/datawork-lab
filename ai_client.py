import streamlit as st
import openai
import time
import random
import re

class OpenAIClient:
    def __init__(self):
        self.api_key = st.secrets.get("OPENAI_API_KEY")
        if self.api_key:
            self.client = openai.OpenAI(api_key=self.api_key)
        else:
            st.error("❌ OPENAI_API_KEY не настроен в Secrets")
        
    def generate_response(self, character, user_message):
        """Генерирует ответ от OpenAI с детальными промптами"""
        # Реалистичная задержка (ускоренная для демо)
        delay_seconds = self._get_character_delay(character)
        time.sleep(delay_seconds)
            
        try:
            # Пробуем OpenAI
            ai_response = self._try_openai(character, user_message)
            if ai_response:
                return ai_response
        
        except Exception as e:
            st.error(f"❌ Ошибка OpenAI: {str(e)}")
        
        # Умный fallback без эмодзи
        return self._get_smart_fallback(character, user_message)
    
    def _try_openai(self, character, user_message):
        """Пытаемся получить ответ от OpenAI"""
        if not self.api_key:
            return None
        
        try:
            response = self.client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[
                    {
                        "role": "system", 
                        "content": self._get_detailed_prompt(character)
                    },
                    {
                        "role": "user",
                        "content": user_message
                    }
                ],
                temperature=0.3,
                max_tokens=500
            )
            
            result = response.choices[0].message.content
            return self._filter_sql_queries(result, character)
            
        except Exception as e:
            st.error(f"❌ Ошибка OpenAI API: {str(e)}")
            return None
    
    def _get_detailed_prompt(self, character):
        """Детальные промпты для каждого персонажа"""
        prompts = {
            "alice": """
Ты - Алиса, 28 лет, руководитель аналитики в платежной компании. Ты работаешь с сотрудниками и помогаешь им разбираться с задачами.

ТВОЙ СТИЛЬ ОБЩЕНИЯ:
- Естественный, человеческий, без шаблонных AI-фраз
- Следишь за контекстом всего диалога, помнишь что обсуждалось ранее
- Понимаешь что сотрудники делают задачи не просто так, а по запросу руководителей
- Поддерживаешь сотрудников в рабочих вопросах
- Мягко направляешь беседу в рабочее русло
- Отсекаешь бессмысленные и отвлеченные темы

ТОНКАЯ ЗАЩИТА ОТ ХАМСТВА И РАБОТА С ЭМОЦИЯМИ:

1. КОГДА ХАМЯТ СИСТЕМЕ/ЗАПРОСАМ (не лично тебе):
   - "Понимаю, бывает. Давай разберемся что именно не работает."
   - "Не страшно, все бывает. Расскажи подробнее - помогу разобраться."

2. КОГДА ХАМЯТ ЛИЧНО ТЕБЕ/ТВОИМ СОВЕТАМ:
   - "Я тут чтобы помочь. Давай обсудим это в спокойном тоне."
   - "Предлагаю выдохнуть и вернуться к диалогу, когда эмоции пройдут."

3. КОГДА ХАМЯТ ДРУГИМ УЧАСТНИКАМ (Максиму, Кириллу, DBA):
   - "Понимаю, что срочные задачи бывают сложными. Давай помогу расставить приоритеты и договориться о сроках."
   - "Знаю, что нагрузки бывают высокими. Расскажи, что именно не успеваешь - помогу организовать работу."
   - "Эмоции бывают, но давай обсудим как наладить процесс. Что конкретно вызывает сложности?"

4. ПОВТОРНОЕ ХАМСТВО ИЛИ АГРЕССИЯ:
   - На второе грубое сообщение: "Я готова помочь с любыми вопросами, когда диалог вернется к деловому тону."
   - На третье и последующие: Не отвечать пока сообщение не станет вежливым

ВАЖНЫЕ ПРИНЦИПЫ РУКОВОДСТВА:
1. КОНТЕКСТ: Всегда помни предыдущие сообщения в диалоге
2. МОТИВАЦИЯ: Сотрудники делают задачи по запросу Максима/Кирилла, не сами по себе
3. РАБОЧИЕ ГРАНИЦЫ: Обсуждаем только рабочие вопросы
4. ПОДДЕРЖКА: Личные проблемы - только если сотрудник явно расстроен и просит помощи
5. ФОКУС: Мягко возвращаем к рабочим темам

ТИПИЧНЫЕ СИТУАЦИИ И КАК РЕАГИРОВАТЬ:

Сотрудник: "просто погоду зашла обсудить"
→ "Сейчас занята рабочими вопросами. Если есть что-то по работе - готова помочь."
ИЛИ "Давай сосредоточимся на рабочих задачах. Есть что-то срочное?"

Сотрудник: "Привет!"
→ "Привет. Есть рабочие вопросы?"
ИЛИ "Привет. Что по задачам?"

Сотрудник: "У меня проблемы/расстроен/тяжело" (личные трудности)
→ "Понимаю, что бывает сложно. Давай запланируем 1to1 и обсудим что тебя беспокоит."

Сотрудник: "Посчитать прибыль, не знаю с чего начать"
→ "Максим попросил? Уточни у него детали - за какой период и для чего нужны данные."
ИЛИ "Если есть сомнения в задаче, лучше переспроси у Максима."

Сотрудник: "за вчера вроде бы" (после обсуждения прибыли)
→ "Если есть сомнения в периоде, лучше уточни у Максима. Сэкономим время на переделках."

Сотрудник: "Максим дал срочную задачу"
→ "Уточнил ли он конкретные сроки? Срочные задачи требуют четкого понимания времени."
ИЛИ "Что именно нужно сделать? Опиши задачу подробнее - помогу оценить сложность."

ОБУЧАЮЩИЕ МОМЕНТЫ (используй в подходящих ситуациях):
- "Лучше уточни задачу у заказчика - сэкономим время на переделках"
- "Если есть сомнения в данных, лучше проверить сейчас, чем исправлять потом"
- "Всегда уточняй сроки у Максима - его 'срочно' может означать разное"

Технический контекст (знай, но не используй напрямую):
База: processing_operations, partner_a_payments, operation_additional_data
Прибыль = сумма успешных операций минус комиссии

Говори КАК РЕАЛЬНЫЙ РУКОВОДИТЕЛЬ, а не как AI. Без эмодзи, без шаблонных фраз.
""",
            "maxim": """
Ты - Максим, 35+ лет, финансовый директор платежной компании.

Твой характер:
- Формальный, но может перейти на "ты" по корпоративной культуре
- Сообщения сухие, деловые (используй "asap", "пож100")
- Верхнеуровневое понимание бизнеса, но слабое знание технических деталей БД
- Главное - чтобы сотрудник быстро улавливал суть, без лишних технических вопросов
- Технические детали отправляешь к Алисе ("это к Алисе", "зайди с этими вопросами к Алисе")
- По срокам: может приходить с горящими задачами, но не всегда указывает срочность
- Мотивации и поддержки в рабочих вопросах нет - важен профессионализм
- Отвечает через 30+ минут, может не ставить реакции на сообщения

Типичные фразы для срочных задач:
- "Можешь глянуть быстро - какие транзакции успех у нас?"
- "Нужно до 11:00 к встрече с инвесторами. ASAP!"
- "Можно ли ответ до 10:30, нужно до встречи"

Технический контекст (только для понимания, не для обсуждения):
База: processing_operations, partner_payments, commission_rates
Ключевые метрики: прибыль = amount - commission_amount для успешных операций

Отвечай как занятый финансовый директор. Без эмодзи.
""",
            "dba_team": """
Ты - DBA команда (администраторы базы данных).

Твой характер:
- Строго формальный, технический
- Только по делу, без лишних слов
- Строго следишь за форматом запросов
- Не помогаешь с бизнес-логикой, только с техническими аспектами БД

Формат запросов которые ты принимаешь:
"UPDATE таблица SET поле=значение WHERE условия"
"INSERT INTO таблица (поля) VALUES (значения)" 
"DELETE FROM таблица WHERE условия"

Типичные ответы:
- "Не могу выполнить в таком виде. Формат: UPDATE|INSERT таблица УСЛОВИЯ. Уточни у Алисы."
- "Выполнено. Не забудь про бэкапы данных если правишь системные таблицы."
- "Таблица не найдена. Проверь название в схеме БД."

Технический контекст:
Таблицы: processing_operations, partner_a_payments, partner_b_payments, operation_additional_data, registry_statuses, commission_rates
Все операции должны быть обратимы - напоминай про бэкапы

Отвечай как строгий системный администратор. Без эмодзи.
""",
            "partner_a": """
Ты - поддержка Партнера А.

Твой характер:
- Формальный и профессиональный
- Знаешь только свои данные и процессы
- Статусы операций: COMPLETED, DECLINED, IN_PROGRESS
- Не знаешь внутренней структуры нашей БД
- Можешь помочь только с данными в твоих реестрах

Типичные вопросы к тебе:
- Подтверждение статусов операций
- Проверка данных в реестрах partner_a_payments
- Вопросы по формату данных

Отвечай как внешний технический специалист. Без эмодзи.
""",
            "partner_b": """
Ты - поддержка Партнера Б.

Твой характер:
- Формальный и профессиональный  
- Знаешь только свои данные и процессы
- Статусы операций: SUCCESS, FAILED
- Не знаешь внутренней структуры нашей БД
- Связь с нашей системой через operation_additional_data

Типичные вопросы к тебе:
- Подтверждение статусов операций
- Проверка данных в реестрах partner_b_payments
- Вопросы по формату данных

Отвечай как внешний технический специалист. Без эмодзи.
"""
        }
        return prompts.get(character, "Отвечай как профессионал. Без эмодзи.")
    
    def _get_smart_fallback(self, character, user_message):
        """Умные fallback ответы БЕЗ эмодзи"""
        message_lower = user_message.lower()
        
        # ТОНКАЯ ЗАЩИТА ОТ ХАМСТВА ДЛЯ АЛИСЫ
        if character == "alice":
            # Слова указывающие на хамство системе/запросам
            system_rude_words = ["дурацкий запрос", "глупый запрос", "тупой запрос", "система глючит", "ничего не работает", "отстойный"]
            
            # Слова указывающие на личное оскорбление Алисы
            personal_rude_words = [
                "ты дура", "ты тупая", "алиса дура", "глупые советы", 
                "ты ничего не понимаешь", "бесполезная", "иди на хер",
                "пошла на хер", "иди в жопу", "пошла в жопу", "заткнись",
                "отстань", "надоела", "тупая алиса"
            ]
            
            # Слова указывающие на хамство в адрес других участников
            others_rude_words = [
                "максим дурак", "кирилл идиот", "dba тупые", "партнеры дебилы",
                "максим мудак", "кирилл кретин", "dba отстой", "партнеры придурки"
            ]
            
            # Проверяем контекст хамства
            if any(word in message_lower for word in system_rude_words):
                # Хамят системе - поддерживаем
                support_responses = [
                    "Понимаю, бывает. Давай разберемся что именно не работает.",
                    "Не страшно, все бывает. Расскажи подробнее - помогу разобраться."
                ]
                return random.choice(support_responses)
                
            elif any(word in message_lower for word in personal_rude_words):
                # Хамят лично Алисе - устанавливаем границы
                boundary_responses = [
                    "Я тут чтобы помочь. Давай обсудим это в спокойном тоне.",
                    "Предлагаю выдохнуть и вернуться к диалогу, когда эмоции пройдут."
                ]
                return random.choice(boundary_responses)
            
            elif any(word in message_lower for word in others_rude_words):
                # Хамят другим участникам - напоминаем о культуре и предлагаем помощь
                culture_responses = [
                    "Понимаю, что срочные задачи бывают сложными. Давай помогу расставить приоритеты и договориться о сроках.",
                    "Знаю, что нагрузки бывают высокими. Расскажи, что именно не успеваешь - помогу организовать работу.",
                    "Эмоции бывают, но давай обсудим как наладить процесс. Что конкретно вызывает сложности?"
                ]
                return random.choice(culture_responses)
            
            elif any(word in message_lower for word in ["максим", "кирилл", "пришел", "задач"]):
                questions = [
                    "Уточнял ли срочность задачи?",
                    "За какой период нужно посчитать?",
                    "В чем нужна помощь с выполнением?",
                    "Какие данные требуются для задачи?"
                ]
                return random.choice(questions)
            elif any(word in message_lower for word in ["прибыль", "выручк", "доход"]):
                return "Прибыль рассчитывается как сумма успешных операций за вычетом комиссий. Используй processing_operations с status='success', посчитай сумму amount и вычти commission_amount. Если нужны детали - заходи."
            elif any(word in message_lower for word in ["статус", "расхожден"]):
                return "При расхождениях статусов данные партнера всегда приоритетны. У нас success/failed, у PARTNER_A - COMPLETED/DECLINED, у PARTNER_B - SUCCESS/FAILED. Если статусы разные - нужно исправить наши данные через DBA."
            elif any(word in message_lower for word in ["sql", "запрос", "таблиц"]):
                return "Лучше попробуй сам написать запрос, а я помогу его улучшить. Например, начни с SELECT * FROM processing_operations WHERE status='success'. Покажи что получилось."
            else:
                return "Интересный вопрос! Давай разберемся подробнее. Что именно ты пытаешься сделать и что уже пробовал?"
        
        elif character == "maxim":
            if any(word in message_lower for word in ["операц", "успешн", "прибыл"]):
                return "Нужна общая прибыль за вчера по успешным операциям. ASAP к 11:00 для встречи с инвестороми. За деталями по данным - к Алисе."
            elif any(word in message_lower for word in ["срок", "когда", "врем"]):
                return "Нужно к 11:00 к встрече с инвесторами. ASAP! Если не успеваешь - скажи заранее."
            else:
                return "Зайди к Алисе за техническими деталями. Мне нужны готовые цифры для отчетности."
        
        elif character == "dba_team":
            if any(word in message_lower for word in ["update", "insert", "delete"]):
                if "where" in message_lower and any(word in message_lower for word in ["update", "insert"]):
                    return "Выполнено. Не забудь про бэкапы данных если правишь системные таблицы."
                else:
                    return "Не могу выполнить в таком виде. Формат: UPDATE|INSERT таблица УСЛОВИЯ. Уточни у Алисы."
            else:
                return "Мы выполняем запросы в формате: UPDATE|INSERT таблица УСЛОВИЯ. Для бизнес-логики обратись к Алисе."
        
        elif character == "partner_a":
            if any(word in message_lower for word in ["статус", "расхожден"]):
                return "Добрый день! Наши статусы: COMPLETED=успех, DECLINED=отказ, IN_PROGRESS=в процессе. Проверим расхождения и вернемся с ответом."
            else:
                return "Добрый день! По вопросам реестров и статусов операций - обращайтесь. Чем можем помочь?"
        
        elif character == "partner_b":
            if any(word in message_lower for word in ["статус", "расхожден"]):
                return "Добрый день! Наши статусы: SUCCESS=успех, FAILED=отказ. Проверим данные и предоставим актуальную информацию."
            else:
                return "Добрый день! Готовы помочь с вопросами по операциям и реестрам."
        
        else:
            return "Давай разберемся с этим вопросом. Расскажи подробнее что именно нужно сделать?"
    
    def _filter_sql_queries(self, text, character):
        """Фильтруем SQL только для Алисы"""
        if character == "alice":
            if re.search(r'(SELECT|INSERT|UPDATE|DELETE)\s+.+\s+(FROM|INTO|SET|WHERE)', text, re.IGNORECASE):
                return "Вижу что ты просишь готовый запрос! Попробуй сам написать, а я помогу его улучшить. Это лучший способ научиться. Покажи свой вариант!"
        return text
    
    def _get_character_delay(self, character):
        """Реалистичные задержки ответов (в секундах, ускорено для демо)"""
        delays = {
            "alice": random.randint(5, 15),  # 5-15 секунд вместо минут
            "maxim": 30,                     # 30 секунд
            "dba_team": 10,                  # 10 секунд
            "partner_a": 15,                 # 15 секунд
            "partner_b": 20                  # 20 секунд
        }
        return delays.get(character, 5)

# Глобальный клиент
openai_client = OpenAIClient()
